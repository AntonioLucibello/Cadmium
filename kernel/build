#!/bin/bash
CADMIUMROOT=$1

set -e
set -v

export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-

mkdir -p tmp
cd $CADMIUMROOT/tmp

mkdir -p linux

if [ "$(date +'%V%y')" != "$(cat kern-dl-date)" ]; then
#	curl -L "$(curl -sL https://www.kernel.org/ | grep "Download complete tarball" | head -n1 | tr '"' ' ' | awk '{print $3}')" -o linux-src
#	bsdtar xf linux-src --strip-components=1 -C linux

#	git clone https://github.com/Maccraft123/linux-duet linux -b panfrost/duet
#	git clone https://github.com/Maccraft123/linux --depth 1
	echo $(date +'%V%y') > kern-dl-date
fi


cd linux

cp $CADMIUMROOT/kernel/config-duet .config
cp $CADMIUMROOT/kernel/kernel.its kernel.its
cp $CADMIUMROOT/kernel/cmdline cmdline

pwd
for x in $(ls $CADMIUMROOT/kernel/patches/); do
	patch -p1 < $CADMIUMROOT/kernel/patches/$x
done

make oldconfig
make nconfig

cp $CADMIUMROOT/kernel/config-duet $CADMIUMROOT/kernel/config-duet.old
cp .config $CADMIUMROOT/kernel/config-duet

make -j$(nproc)

# kpart
# yes this is stolen from solidhal's prawnos
mkimage -D "-I dts -O dtb -p 2048" -f kernel.its vmlinux.uimg || true
dd if=/dev/zero of=bootloader.bin bs=512 count=1
vbutil_kernel --pack vmlinux.kpart \
	--version 1 \
	--vmlinuz vmlinux.uimg \
	--arch aarch64 \
	--keyblock /usr/share/vboot/devkeys/kernel.keyblock \
	--signprivate /usr/share/vboot/devkeys/kernel_data_key.vbprivk \
	--config cmdline \
	--bootloader bootloader.bin

cp vmlinux.kpart $CADMIUMROOT/
