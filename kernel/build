#!/bin/bash
CADMIUMROOT=$1

[ -z "$CADMIUMROOT" ] && echo "$0: First parameter has to be root dir of Cadmium" && exit 1

set -e
set -v

source $CADMIUMROOT/config

# set env vars
export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-

mkdir -p tmp
cd $CADMIUMROOT/tmp


# check if kernel has been downloaded this week, if not download/update it
if [ "$(date +'%V%y')" != "$(cat kern-dl-date || true)" ]; then
	case $TARGET in	
	duet)
		if [ -d "$CADMIUMROOT/tmp/linux" ]; then
			cd linux
			git pull
			echo $(date +'%V%y') > kern-dl-date
		else
			git clone https://github.com/Maccraft123/linux-duet -b panfrost/duet linux
			echo $(date +'%V%y') > kern-dl-date
			cd linux
		fi
	;;
	*)
		rm -rf linux
		curl -L "$(curl -sL https://www.kernel.org/ | grep "Download complete tarball" | head -n1 | tr '"' ' ' | awk '{print $3}')" -o Linux-archive
		mkdir linux
		bsdtar xf Linux-archive --strip-components=1 -C linux
		echo $(date +'%V%y') > kern-dl-date
	esac
fi

cd linux

cp $CADMIUMROOT/kernel/config-$TARGET .config
cp $CADMIUMROOT/kernel/kernel-$TARGET.its kernel.its
cp $CADMIUMROOT/kernel/cmdline cmdline

#for x in $(ls $CADMIUMROOT/kernel/patches/); do
#	patch -p1 < $CADMIUMROOT/kernel/patches/$x
#done

make nconfig # if you want to customize config just uncomment this

# backup old config if it's different, and copy new custom config
if [ "$(sha1sum $CADMIUMROOT/kernel/config-$TARGET)" = "$(sha1sum .config)" ]; then
	cp $CADMIUMROOT/kernel/config-$TARGET $CADMIUMROOT/kernel/config-$TARGET.old
	cp .config $CADMIUMROOT/kernel/config-$TARGET
fi

echo Bulding in $(pwd) with $(nproc) threads
time make -j$(nproc)

# make kernel partition
# yes this is stolen from solidhal's prawnos, that's how open source works :D
mkimage -D "-I dts -O dtb -p 2048" -f kernel.its vmlinux.uimg || true
dd if=/dev/zero of=bootloader.bin bs=512 count=1
vbutil_kernel --pack vmlinux.kpart \
	--version 1 \
	--vmlinuz vmlinux.uimg \
	--arch aarch64 \
	--keyblock /usr/share/vboot/devkeys/kernel.keyblock \
	--signprivate /usr/share/vboot/devkeys/kernel_data_key.vbprivk \
	--config cmdline \
	--bootloader bootloader.bin

cp vmlinux.kpart $CADMIUMROOT/
