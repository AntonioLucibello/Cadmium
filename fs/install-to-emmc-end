# start of install-to-emmc-end
set -x
set -e

# Already mounted proc for aarch in middle for pacman initialization
if [ $ROOTFS != "arch" ]; then
	mount proc /mnt/proc -t proc # just in case something((gdm)) wants it
fi

echo "Enter root password:"
until chroot /mnt passwd; do
	echo "Enter root password:"
done

# Arch uses visudo. Need to see if we can automate the installation. No sudo group, maybe wheel.
if [ $ROOTFS = "arch" ]; then
  read -p "Enter username, no spaces or big letters: "
  useradd -G video,audio,render -s /bin/bash -m $REPLY
else
  read -p "Enter username, no spaces or big letters: "
  useradd -G sudo,video,audio,render -s /bin/bash -m $REPLY
fi

echo "Enter user password:"
until chroot /mnt passwd $REPLY; do
	echo "Enter user password:"
done

export USERNAME=$REPLY

# default libinput config for touchpad is bad
# let's override it
if [ -f /etc/libinput/local-overrides.quirks ]; then
	mkdir -p /mnt/etc/libinput
	cp /etc/libinput/local-overrides.quirks /mnt/etc/libinput/local-overrides.quirks
fi

if [ -f /accel-matrix.hwdb ]; then
	# eudev has hwdb in different place
	if [ "$EUDEV" = "1" ]; then
		export HWDBPATH=/usr/lib/udev
	else
		export HWDBPATH=/etc/udev/hwdb.d
	fi

	# fix iio-sensor-proxy screen rotation
	mkdir -p /mnt/$HWDBPATH
	cp /accel-matrix.hwdb /mnt/$HWDBPATH/61-sensor-local.hwdb

	# apply the changes
	[ "$SYSTEMD" = "1" ] && chroot /mnt systemd-hwdb update
fi

cp -r /CdFiles /mnt/CdFiles
if [ $BASEBOARD = trogdor ]; then
	chroot /mnt make -C /CdFiles/qmic prefix=/usr install
	chroot /mnt make -C /CdFiles/qrtr prefix=/usr install
	chroot /mnt make -C /CdFiles/rmtfs prefix=/usr install
	chroot /mnt systemctl enable rmtfs
fi

cp ~/info /mnt/CdFiles/info

echo $OXIDE > /mnt/CdFiles/is_oxide

export CHRT='chroot /mnt'
export INST_EMMC=1

# install ui, yes this uses source. deal with it.
source ~/ui/install

umount /mnt/proc
umount /mnt

# copy over ucm files
#TODO: change for arch
cp -r /ucm/* /mnt/usr/share/alsa/ucm2/

echo "Done! :D"
echo "$EXTRAPRINT"