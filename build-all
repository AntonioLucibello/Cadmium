#!/bin/bash
CADMIUMROOT=$(pwd)

. $CADMIUMROOT/config
. $CADMIUMROOT/board/$TARGET/boardinfo

set -e
set -v

sleep 1 # let's give user time if they commit a typo

# Usage:
# build-all <device>
# build-all <file> <size>

[ -z "$1" ] && exit 1

if [ -n "$2" ]; then # if $2 is set, it means that user wants a file
	echo "Making file $1 with size of $2"
	fallocate $CADMIUMROOT/$1 -l $2
	DEVICE=$(losetup -f)
	losetup $DEVICE $CADMIUMROOT/$1

	KERNPART=${DEVICE}p1
	KERNPART_B=${DEVICE}p2
	ROOTPART=${DEVICE}p3
else
	DEVICE=$1
	KERNPART=${DEVICE}1
	KERNPART_B=${DEVICE}2
	ROOTPART=${DEVICE}3
	dd if=/dev/zero of=$DEVICE bs=1M count=64
fi


sync

# make partition table
parted --script $DEVICE mklabel gpt # cgpt dislikes if i don't do that, so do that

# now this is _real_ partition table
# 73728 comes from: size of kernel partition(65536) + beginning of kernel partition(8192)
# 139264 comes from: size of B kernel partition(65536) + beginning of B kernel partition(73728)
cgpt create $1
cgpt add -i 1 -t kernel -b 8192		-s 65536 -l SDKernelA -S 1 -T 2 -P 10 $DEVICE
cgpt add -i 2 -t kernel -b 73728	-s 65536 -l SDKernelB -S 0 -T 2 -P 5 $DEVICE
cgpt add -i 3 -t data -b 139264 -s $(expr $(cgpt show $1 | grep 'Sec GPT table' | awk '{print $1}') - 139264) -l Root $DEVICE
sync

# reread partition table. yes this fails sometimes.
partx -a $DEVICE >/dev/null 2>&1 || true
sync

# build, package and write kernel
./kernel/build $CADMIUMROOT
#./bootfw/$BOOTFW/package $CADMIUMROOT $DEVICE $ROOTPART
dd if=$CADMIUMROOT/tmp/linux-$TARGET/vmlinux.kpart of=$KERNPART

# write filesystem
./fs/build $CADMIUMROOT $ROOTPART

# install modules
make -C $CADMIUMROOT/tmp/linux-$TARGET INSTALL_MOD_PATH=$CADMIUMROOT/tmp/root modules_install

# we don't umount it in fs/build
umount $CADMIUMROOT/tmp/root

# yes, this fails when device is pendrive or sth
losetup -d $DEVICE 2>/dev/null || true

sync

echo "Done!"
